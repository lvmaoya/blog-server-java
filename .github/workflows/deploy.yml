name: Deploy API

on:
  push:
    branches: ["main"]

jobs:
  deploy-api:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Build Spring Boot JAR
        run: ./mvnw -q -DskipTests package

      - name: Backup app.jar on server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e
            PROJECT_DIR="/www/wwwroot/personal_web/docker-deploy/projects/blog-api"
            BACKUP_DIR="$PROJECT_DIR/backups"
            mkdir -p "$BACKUP_DIR"

            if [ -f "$PROJECT_DIR/app.jar" ]; then
              TS=$(date +%Y%m%d%H%M%S)
              cp "$PROJECT_DIR/app.jar" "$BACKUP_DIR/app-$TS.jar"
              echo "Backup created: $BACKUP_DIR/app-$TS.jar"
            else
              echo "No existing app.jar found, skipping backup."
            fi

      - name: Rsync Deploy
        uses: burnett01/rsync-deployments@v0.1.2
        with:
          switches: -avz --delete
          path: target/app.jar
          remote_path: /www/wwwroot/personal_web/docker-deploy/projects/blog-api/
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USER }}
          remote_key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Restart API Container
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e
            cd /www/wwwroot/personal_web/docker-deploy/projects
            docker compose restart api
            echo "API container restarted successfully"
